<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anime Info - Crunchyroll Style</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cr-orange: #f47521;
      --cr-orange-dark: #e06a1d;
      --cr-orange-light: #ff9a3d;
      --cr-black: #121212;
      --cr-dark-gray: #1a1a1a;
      --cr-medium-gray: #2a2a2a;
      --cr-light-gray: #757575;
      --cr-white: #f5f5f5;
      --cr-green: #2ecc71;
      --cr-red: #e74c3c;
      --cr-blue: #3498db;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.2);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(180deg, var(--cr-black) 0%, var(--cr-dark-gray) 100%);
      color: var(--cr-white);
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header styling */
    .header {
      background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-md);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
    }
    
    .back-btn {
      color: var(--cr-white);
      text-decoration: none;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 30px;
      background: var(--cr-medium-gray);
      transition: var(--transition);
    }
    
    .back-btn:hover {
      background: var(--cr-orange);
      transform: translateX(-3px);
    }
    
    .logo {
      margin-left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }
    
    .logo-icon {
      color: var(--cr-orange);
      font-size: 24px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--cr-orange), var(--cr-orange-light));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    
    /* Main content styling */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Anime hero section */
    .anime-hero {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .anime-poster {
      flex: 0 0 300px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      height: 450px;
      position: relative;
    }
    
    .anime-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: var(--transition);
    }
    
    .anime-poster:hover img {
      transform: scale(1.03);
    }
    
    .anime-poster .badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--cr-orange);
      color: var(--cr-black);
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      box-shadow: var(--shadow-sm);
    }
    
    .anime-details {
      flex: 1;
      min-width: 300px;
    }
    
    .anime-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--cr-orange);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .anime-title .favorite-btn {
      background: none;
      border: none;
      color: var(--cr-light-gray);
      cursor: pointer;
      font-size: 24px;
      transition: var(--transition);
    }
    
    .anime-title .favorite-btn.active {
      color: var(--cr-red);
    }
    
    .anime-title .favorite-btn:hover {
      transform: scale(1.1);
    }
    
    .japanese-title {
      font-size: 20px;
      color: var(--cr-light-gray);
      margin-bottom: 20px;
      font-weight: 400;
      border-bottom: 2px solid var(--cr-medium-gray);
      padding-bottom: 15px;
    }
    
    .anime-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--cr-medium-gray);
      padding-bottom: 20px;
    }
    
    .meta-item {
      background: var(--cr-medium-gray);
      padding: 8px 15px;
      border-radius: 30px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: var(--transition);
    }
    
    .meta-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .rating {
      background: var(--cr-orange);
      color: var(--cr-black);
      font-weight: 700;
    }
    
    .status {
      background: var(--cr-green);
      color: var(--cr-black);
    }
    
    .synopsis {
      background: var(--cr-dark-gray);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      line-height: 1.8;
      border-left: 4px solid var(--cr-orange);
      box-shadow: var(--shadow-md);
      position: relative;
    }
    
    .synopsis-title {
      font-size: 22px;
      margin-bottom: 15px;
      color: var(--cr-orange);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .synopsis .expand-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: var(--cr-medium-gray);
      color: var(--cr-white);
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .synopsis .expand-btn:hover {
      background: var(--cr-orange);
    }
    
    .synopsis.collapsed {
      max-height: 150px;
      overflow: hidden;
      mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
    }
    
    /* Additional info section */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .info-card {
      background: var(--cr-dark-gray);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }
    
    .info-card h3 {
      color: var(--cr-orange);
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-card p {
      font-size: 14px;
    }
    
    /* Characters section */
    .characters-section {
      margin-bottom: 40px;
    }
    
    .characters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .character-card {
      background: var(--cr-dark-gray);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    
    .character-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    
    .character-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    
    .character-info {
      padding: 12px;
    }
    
    .character-name {
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .character-role {
      font-size: 12px;
      color: var(--cr-light-gray);
    }
    
    /* Episodes section */
    .episodes-section {
      margin-top: 40px;
      background: var(--cr-dark-gray);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    .section-header {
      background: var(--cr-black);
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--cr-medium-gray);
    }
    
    .section-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-icon {
      color: var(--cr-orange);
    }
    
    .episodes-container {
      padding: 25px;
    }
    
    .episodes-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .episode-item {
      background: var(--cr-medium-gray);
      border-radius: 8px;
      padding: 15px;
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .episode-item:hover {
      background: var(--cr-orange);
      transform: translateX(5px);
    }
    
    .episode-number {
      background: var(--cr-black);
      color: var(--cr-white);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .episode-title {
      font-size: 16px;
      font-weight: 500;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .play-icon {
      color: var(--cr-white);
      font-size: 18px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .episode-item:hover .play-icon {
      opacity: 1;
    }
    
    /* Recommendations section */
    .recommendations {
      margin-top: 40px;
    }
    
    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .recommendation-card {
      background: var(--cr-dark-gray);
      border-radius: 8px;
      overflow: hidden;
      transition: var(--transition);
    }
    
    .recommendation-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    
    .recommendation-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }
    
    .recommendation-info {
      padding: 12px;
    }
    
    .recommendation-title {
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .recommendation-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--cr-light-gray);
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--cr-orange);
      font-size: 18px;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--cr-orange);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error state */
    .error {
      text-align: center;
      padding: 50px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .error-icon {
      font-size: 48px;
      color: var(--cr-red);
      margin-bottom: 20px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .anime-hero {
        flex-direction: column;
      }
      
      .anime-poster {
        flex: 0 0 auto;
        max-width: 300px;
        margin: 0 auto;
        height: 400px;
      }
      
      .episodes-list {
        grid-template-columns: 1fr;
      }
      
      .info-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .characters-grid,
      .recommendations-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 12px 10px;
      }
      
      .logo-text {
        font-size: 20px;
      }
      
      .back-btn {
        padding: 6px 12px;
        font-size: 14px;
      }
      
      .anime-title {
        font-size: 26px;
      }
      
      .japanese-title {
        font-size: 16px;
      }
      
      .section-title {
        font-size: 20px;
      }
      
      .episodes-container {
        padding: 15px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="index.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Back
    </a>
    <a href="#" class="logo">
      <div class="logo-icon">▶</div>
      <div class="logo-text">AnimeHub</div>
    </a>
  </header>
  
  <div class="container">
    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        Loading anime details...
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      jsonFiles: [
        "popular.json", 
        "action.json", 
        "slice_of_life.json", 
        "sci-fi.json", 
        "drama.json", 
        "comedy.json", 
        "fantasy.json"
      ],
      maxRecommendations: 6,
      maxCharacters: 12
    };

    // Utility functions
    const utils = {
      getUrlParam: (name) => {
        const params = new URLSearchParams(window.location.search);
        return decodeURIComponent(params.get(name));
      },
      
      fetchWithTimeout: (url, options = {}, timeout = 5000) => {
        return Promise.race([
          fetch(url, options),
          new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Request timeout')), timeout)
          )
        ]);
      },
      
      truncateText: (text, maxLength = 200) => {
        if (text.length > maxLength) {
          return text.substring(0, maxLength) + '...';
        }
        return text;
      },
      
      getRandomItems: (array, count) => {
        const shuffled = [...array].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
      },
      
      setFavorite: (animeId, isFavorite) => {
        const favorites = JSON.parse(localStorage.getItem('animeFavorites') || {};
        if (isFavorite) {
          favorites[animeId] = true;
        } else {
          delete favorites[animeId];
        }
        localStorage.setItem('animeFavorites', JSON.stringify(favorites));
      },
      
      isFavorite: (animeId) => {
        const favorites = JSON.parse(localStorage.getItem('animeFavorites') || '{}');
        return !!favorites[animeId];
      }
    };

    // Main application
    document.addEventListener('DOMContentLoaded', () => {
      const title = utils.getUrlParam('title');
      
      if (!title) {
        showError('No anime title specified');
        return;
      }
      
      loadAnimeData(title);
    });

    async function loadAnimeData(title) {
      try {
        // Show loading state
        document.getElementById('content').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Loading anime details...
          </div>
        `;
        
        // Load all JSON files in parallel with timeout
        const jsonPromises = CONFIG.jsonFiles.map(file => 
          utils.fetchWithTimeout(file).then(r => r.json())
        );
        
        const files = await Promise.all(jsonPromises);
        const allAnime = files.flat();
        const anime = allAnime.find(a => a.anime_name.toLowerCase() === title.toLowerCase());
        
        if (!anime) {
          showError(`Could not find "${title}" in our database`);
          return;
        }
        
        renderAnimePage(anime, allAnime);
        
        // Initialize event listeners after render
        setTimeout(() => {
          initEventListeners(anime);
        }, 100);
        
      } catch (error) {
        console.error("Error loading anime data:", error);
        showError("There was an issue loading the anime details. Please try again later.");
      }
    }

    function renderAnimePage(anime, allAnime) {
      const { metadata, episodes } = anime;
      const isFav = utils.isFavorite(anime.anime_name);
      
      // Get recommendations (exclude current anime)
      const recommendations = utils.getRandomItems(
        allAnime.filter(a => a.anime_name !== anime.anime_name),
        CONFIG.maxRecommendations
      );
      
      // Get main characters (if available)
      const characters = metadata.characters 
        ? metadata.characters.slice(0, CONFIG.maxCharacters)
        : [];
      
      document.getElementById('content').innerHTML = `
        <div class="anime-hero">
          <div class="anime-poster">
            <img src="${metadata.image}" alt="${metadata.title}" loading="lazy">
            ${metadata.type ? `<div class="badge">${metadata.type}</div>` : ''}
          </div>
          <div class="anime-details">
            <h1 class="anime-title">
              ${metadata.title}
              <button class="favorite-btn ${isFav ? 'active' : ''}" data-anime="${anime.anime_name}">
                <i class="fas fa-heart"></i>
              </button>
            </h1>
            <div class="japanese-title">${metadata.japanese_title}</div>
            
            <div class="anime-meta">
              <div class="meta-item rating">
                <i class="fas fa-star"></i> ${metadata.score || 'N/A'}
              </div>
              <div class="meta-item">
                <i class="fas fa-film"></i> ${episodes.length} Episodes
              </div>
              ${metadata.type ? `
                <div class="meta-item">
                  <i class="fas fa-tag"></i> ${metadata.type}
                </div>
              ` : ''}
              ${metadata.status ? `
                <div class="meta-item status">
                  <i class="fas fa-circle"></i> ${metadata.status}
                </div>
              ` : ''}
              ${metadata.year ? `
                <div class="meta-item">
                  <i class="fas fa-calendar"></i> ${metadata.year}
                </div>
              ` : ''}
            </div>
            
            <div class="synopsis ${metadata.synopsis.length > 300 ? 'collapsed' : ''}">
              <h3 class="synopsis-title">
                <i class="fas fa-book-open"></i> Synopsis
              </h3>
              <p>${metadata.synopsis}</p>
              ${metadata.synopsis.length > 300 ? `
                <button class="expand-btn">Show More</button>
              ` : ''}
            </div>
            
            ${metadata.genres || metadata.studio || metadata.director ? `
              <div class="info-grid">
                ${metadata.genres ? `
                  <div class="info-card">
                    <h3><i class="fas fa-tags"></i> Genres</h3>
                    <p>${metadata.genres.join(', ')}</p>
                  </div>
                ` : ''}
                ${metadata.studio ? `
                  <div class="info-card">
                    <h3><i class="fas fa-building"></i> Studio</h3>
                    <p>${metadata.studio}</p>
                  </div>
                ` : ''}
                ${metadata.director ? `
                  <div class="info-card">
                    <h3><i class="fas fa-user"></i> Director</h3>
                    <p>${metadata.director}</p>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
        
        ${characters.length > 0 ? `
          <div class="characters-section">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-users section-icon"></i> Main Characters
              </h2>
            </div>
            <div class="characters-grid">
              ${characters.map(char => `
                <div class="character-card">
                  <img src="${char.image || 'https://via.placeholder.com/150x225?text=No+Image'}" 
                       alt="${char.name}" 
                       class="character-image"
                       loading="lazy">
                  <div class="character-info">
                    <div class="character-name">${char.name}</div>
                    <div class="character-role">${char.role || 'Character'}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="episodes-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-list section-icon"></i> Episodes
            </h2>
            <div class="meta-item">
              ${episodes.length} Episodes
            </div>
          </div>
          <div class="episodes-container">
            <div class="episodes-list">
              ${episodes.map(ep => `
                <div class="episode-item" data-episode="${ep.episode}" onclick="play('${anime.anime_name}', '${ep.episode}')">
                  <div class="episode-number">${ep.episode.split(' ')[1]}</div>
                  <div class="episode-title" title="${ep.episode}: ${ep.title}">
                    ${ep.episode}: ${ep.title}
                  </div>
                  <div class="play-icon">
                    <i class="fas fa-play"></i>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
        
        ${recommendations.length > 0 ? `
          <div class="recommendations">
            <div class="section-header">
              <h2 class="section-title">
                <i class="fas fa-thumbs-up section-icon"></i> You Might Also Like
              </h2>
            </div>
            <div class="recommendations-grid">
              ${recommendations.map(rec => `
                <a href="anime.html?title=${encodeURIComponent(rec.anime_name)}" class="recommendation-card">
                  <img src="${rec.metadata.image}" 
                       alt="${rec.metadata.title}" 
                       class="recommendation-image"
                       loading="lazy">
                  <div class="recommendation-info">
                    <div class="recommendation-title">${rec.metadata.title}</div>
                    <div class="recommendation-meta">
                      <span><i class="fas fa-star"></i> ${rec.metadata.score || 'N/A'}</span>
                      <span>${rec.episodes.length} Episodes</span>
                    </div>
                  </div>
                </a>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }

    function initEventListeners(anime) {
      // Expand/collapse synopsis
      const expandBtn = document.querySelector('.synopsis .expand-btn');
      if (expandBtn) {
        expandBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const synopsis = document.querySelector('.synopsis');
          synopsis.classList.toggle('collapsed');
          expandBtn.textContent = synopsis.classList.contains('collapsed') 
            ? 'Show More' 
            : 'Show Less';
        });
      }
      
      // Favorite button
      const favBtn = document.querySelector('.favorite-btn');
      if (favBtn) {
        favBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const isFavorite = favBtn.classList.contains('active');
          utils.setFavorite(anime.anime_name, !isFavorite);
          favBtn.classList.toggle('active');
          
          // Add animation
          favBtn.style.transform = 'scale(1.3)';
          setTimeout(() => {
            favBtn.style.transform = '';
          }, 300);
        });
      }
      
      // Track which episode was hovered (for analytics)
      const episodeItems = document.querySelectorAll('.episode-item');
      episodeItems.forEach(item => {
        item.addEventListener('mouseenter', () => {
          const episode = item.dataset.episode;
          // Could send analytics event here
        });
      });
    }

    function play(title, episode) {
      const encodedTitle = encodeURIComponent(title);
      const encodedEp = encodeURIComponent(episode);
      window.location.href = `player.html?title=${encodedTitle}&ep=${encodedEp}`;
    }

    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="error">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h2>Error Loading Content</h2>
          <p>${message}</p>
          <a href="index.html" class="back-btn" style="display: inline-block; margin-top: 20px;">
            <i class="fas fa-arrow-left"></i> Back to Home
          </a>
        </div>
      `;
    }
  </script>
</body>
</html>
