<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniStream - Premium Anime Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (All existing CSS remains unchanged) */
        
        /* New loading indicator styles */
        .progress-container {
            width: 100%;
            height: 4px;
            background: var(--dark-alt);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 6px;
            right: 10px;
            color: var(--light);
            font-size: 0.8rem;
        }
        
        /* Visible loading spinner */
        .visible-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-left: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #2a303a 25%, #1e232b 50%, #2a303a 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite linear;
            border-radius: 4px;
        }
        
        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-img {
            height: 350px;
            width: 100%;
        }
        
        .skeleton-title {
            height: 20px;
            width: 80%;
            margin: 10px 0;
        }
        
        .skeleton-meta {
            height: 16px;
            width: 60%;
        }
        
        .grid-skeleton-img {
            height: 280px;
            width: 100%;
        }
        
        .grid-skeleton-title {
            height: 18px;
            width: 90%;
            margin: 8px 0;
        }
        
        .grid-skeleton-episodes {
            height: 14px;
            width: 70%;
        }
        
        /* Loading status text */
        .loading-status {
            text-align: center;
            padding: 20px;
            color: var(--light-alt);
            font-size: 0.9rem;
        }
        
        .load-more {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 10px 20px;
            background: var(--primary);
            color: var(--dark);
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .load-more:hover {
            background: var(--primary-dark);
        }
        
        /* Priority loading for visible items */
        .priority-loading {
            animation: priority-pulse 1.5s infinite;
        }
        
        @keyframes priority-pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 117, 33, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(244, 117, 33, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 117, 33, 0); }
        }
    </style>
</head>
<body>
    <!-- Progress bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-text" id="progressText">Loading...</div>
    </div>
    
    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fas fa-play-circle"></i>
            AniStream
        </div>
        <div class="search-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search anime...">
            </div>
            <button class="search-btn" id="searchButton">Search</button>
        </div>
    </header>

    <!-- Featured Anime -->
    <section class="featured">
        <div class="section-header">
            <h2 class="section-title">Popular This Season</h2>
            <a href="#" class="view-all">View All</a>
        </div>
        <div class="featured-carousel" id="featuredCarousel">
            <!-- Featured anime will be loaded here -->
        </div>
    </section>

    <!-- Genre Filter -->
    <section class="genre-filter">
        <div class="genre-buttons" id="genreButtons">
            <button class="genre-btn active" data-genre="all">All</button>
            <button class="genre-btn" data-genre="Action">Action</button>
            <button class="genre-btn" data-genre="Adventure">Adventure</button>
            <button class="genre-btn" data-genre="Comedy">Comedy</button>
            <button class="genre-btn" data-genre="Drama">Drama</button>
            <button class="genre-btn" data-genre="Fantasy">Fantasy</button>
            <button class="genre-btn" data-genre="Romance">Romance</button>
            <button class="genre-btn" data-genre="Sci-Fi">Sci-Fi</button>
            <button class="genre-btn" data-genre="Slice of Life">Slice of Life</button>
        </div>
    </section>

    <!-- Anime Grid -->
    <section class="anime-grid" id="animeGrid">
        <!-- Anime cards will be loaded here -->
    </section>
    
    <!-- Load More Button -->
    <button class="load-more" id="loadMore">Load More</button>
    
    <!-- Loading Status -->
    <div class="loading-status" id="loadingStatus"></div>

    <!-- Anime Detail Modal -->
    <div class="modal" id="animeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Anime Title</div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="anime-detail-container">
                <div class="anime-poster">
                    <img id="animePoster" src="" alt="Anime Poster">
                </div>
                <div class="anime-info-container">
                    <div class="anime-meta-grid">
                        <div class="meta-item">
                            <div class="meta-label">Rating</div>
                            <div class="meta-value rating-value" id="animeRating">N/A</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Episodes</div>
                            <div class="meta-value" id="animeEpisodes">?</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Year</div>
                            <div class="meta-value" id="animeYear">?</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Status</div>
                            <div class="meta-value" id="animeStatus">Unknown</div>
                        </div>
                    </div>

                    <div class="genre-tags" id="animeGenres">
                        <!-- Genres will be inserted here -->
                    </div>

                    <div class="anime-description" id="animeDescription">
                        Loading description...
                    </div>

                    <div class="episodes-section">
                        <h3>Episodes</h3>
                        <div class="episodes-grid" id="episodesGrid">
                            <!-- Episodes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const featuredCarousel = document.getElementById('featuredCarousel');
        const animeGrid = document.getElementById('animeGrid');
        const genreButtons = document.querySelectorAll('.genre-btn');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const animeModal = document.getElementById('animeModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const animePoster = document.getElementById('animePoster');
        const animeRating = document.getElementById('animeRating');
        const animeEpisodes = document.getElementById('animeEpisodes');
        const animeYear = document.getElementById('animeYear');
        const animeStatus = document.getElementById('animeStatus');
        const animeGenres = document.getElementById('animeGenres');
        const animeDescription = document.getElementById('animeDescription');
        const episodesGrid = document.getElementById('episodesGrid');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const loadingStatus = document.getElementById('loadingStatus');
        const loadMore = document.getElementById('loadMore');

        // Configuration
        const jsonFiles = [
            'part1.json',
            'part2.json',
            'finish.json',
            'finis.json',
            'part4.json'
        ];
        
        // Chunk size for loading
        const CHUNK_SIZE = 20;
        
        // Animation frame for throttling
        let lastAnimationFrame = 0;

        // Popular anime titles by genre
        const popularAnimeByGenre = {
            "Action": [
                "Demon Slayer: Kimetsu no Yaiba",
                "Attack on Titan",
                "Jujutsu Kaisen",
                "One Punch Man",
                "My Hero Academia"
            ],
            "Adventure": [
                "One Piece",
                "Hunter x Hunter",
                "Naruto Shippuden",
                "Dragon Ball Z",
                "Fairy Tail"
            ],
            "Comedy": [
                "Gintama",
                "One Punch Man",
                "The Disastrous Life of Saiki K.",
                "Daily Lives of High School Boys",
                "Konosuba"
            ],
            "Drama": [
                "Your Lie in April",
                "Clannad: After Story",
                "Violet Evergarden",
                "Anohana",
                "A Silent Voice"
            ],
            "Fantasy": [
                "Attack on Titan",
                "Re:Zero",
                "Sword Art Online",
                "No Game No Life",
                "The Rising of the Shield Hero"
            ],
            "Romance": [
                "Fruits Basket",
                "Toradora!",
                "Your Lie in April",
                "Clannad",
                "Kaguya-sama: Love is War"
            ],
            "Sci-Fi": [
                "Steins;Gate",
                "Cowboy Bebop",
                "Psycho-Pass",
                "Neon Genesis Evangelion",
                "Dr. Stone"
            ],
            "Slice of Life": [
                "March Comes in Like a Lion",
                "Barakamon",
                "Usagi Drop",
                "Non Non Biyori",
                "Hyouka"
            ]
        };

        let allAnime = [];
        let animeDetailsCache = {};
        let currentGenre = 'all';
        let displayedAnime = 0;
        let isSearching = false;
        let searchTerm = '';
        let isLoading = false;
        let visibleItems = new Set();

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            // Show progress bar
            showProgress(0, "Initializing...");
            
            // Close modal event
            closeModal.addEventListener('click', () => {
                animeModal.classList.remove('active');
            });

            // Search button event
            searchButton.addEventListener('click', () => {
                searchTerm = searchInput.value.trim().toLowerCase();
                displayedAnime = 0;
                animeGrid.innerHTML = '';
                loadAnimeGrid();
            });

            // Search on Enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchTerm = searchInput.value.trim().toLowerCase();
                    displayedAnime = 0;
                    animeGrid.innerHTML = '';
                    loadAnimeGrid();
                }
            });
            
            // Load more button
            loadMore.addEventListener('click', () => {
                loadAnimeGrid();
            });
            
            // Setup Intersection Observer for visible items
            setupIntersectionObserver();

            // Load cached data if available
            const cachedAnime = localStorage.getItem('cachedAnime');
            const cachedDetails = localStorage.getItem('cachedAnimeDetails');

            if (cachedAnime && cachedDetails) {
                try {
                    allAnime = JSON.parse(cachedAnime);
                    animeDetailsCache = JSON.parse(cachedDetails);
                    
                    // Update progress
                    showProgress(30, "Loading UI...");
                    
                    // Load UI components
                    loadInitialUI();
                    
                    // Update progress
                    showProgress(70, "Loading remaining anime...");
                    
                    // Load remaining anime in background
                    setTimeout(() => loadRemainingAnime(), 500);
                } catch (e) {
                    console.error('Error loading cached data', e);
                    loadPopularAnime();
                }
            } else {
                // Load popular anime first
                loadPopularAnime();
            }
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Show progress bar
        function showProgress(percent, text) {
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }
        
        // Hide progress bar
        function hideProgress() {
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 300);
        }
        
        // Setup Intersection Observer
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        const title = card.dataset.title;
                        visibleItems.add(title);
                        
                        // Prioritize loading for this item
                        if (title && animeDetailsCache[title]) {
                            updateCardWithDetails(card, animeDetailsCache[title]);
                        } else if (title) {
                            loadAnimeDetails(title).then(details => {
                                updateCardWithDetails(card, details);
                            });
                        }
                    }
                });
            }, { threshold: 0.1 });
            
            // Observe all anime cards
            document.querySelectorAll('.anime-card, .grid-anime-card').forEach(card => {
                observer.observe(card);
            });
        }
        
        // Update card with details
        function updateCardWithDetails(card, details) {
            if (card.classList.contains('anime-card')) {
                // Featured card
                card.innerHTML = `
                    <div class="anime-img">
                        <img src="${details.image}" alt="${details.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                    </div>
                    <div class="anime-info">
                        <div class="anime-title">${details.title}</div>
                        <div class="anime-meta">
                            <span>${details.year || '?'}</span>
                            <span class="anime-rating">⭐ ${details.rating || 'N/A'}</span>
                        </div>
                    </div>
                `;
                // Reattach click event
                const anime = allAnime.find(a => a.title === details.title);
                if (anime) {
                    card.addEventListener('click', () => openAnimeDetail(anime));
                }
            } else {
                // Grid card
                card.innerHTML = `
                    <div class="grid-img">
                        <img src="${details.image}" alt="${details.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                    </div>
                    <div class="grid-info">
                        <div class="grid-title">${details.title}</div>
                        <div class="grid-episodes">${details.episodes} episodes</div>
                    </div>
                `;
                // Reattach click event
                const anime = allAnime.find(a => a.title === details.title);
                if (anime) {
                    card.addEventListener('click', () => openAnimeDetail(anime));
                }
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Genre filter
            genreButtons.forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelector('.genre-btn.active').classList.remove('active');
                    button.classList.add('active');
                    currentGenre = button.dataset.genre;
                    displayedAnime = 0;
                    animeGrid.innerHTML = '';
                    loadAnimeGrid();
                });
            });

            // Header scroll effect
            window.addEventListener('scroll', handleHeaderScroll);
        }
        
        // Handle header scroll effect
        function handleHeaderScroll() {
            const header = document.querySelector('header');
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            // Check if we're near the bottom for infinite scroll
            handleInfiniteScroll();
        }

        // Load popular anime for initial display
        async function loadPopularAnime() {
            showProgress(10, "Loading popular anime...");
            
            // Get all popular anime titles
            const popularTitles = new Set(Object.values(popularAnimeByGenre).flat());
            
            // Show skeleton for featured section
            featuredCarousel.innerHTML = '';
            popularTitles.forEach(title => {
                const card = document.createElement('div');
                card.className = 'anime-card skeleton';
                card.innerHTML = `
                    <div class="skeleton-img"></div>
                    <div class="anime-info">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-meta"></div>
                    </div>
                `;
                featuredCarousel.appendChild(card);
            });
            
            // Load data for popular anime
            let loadedCount = 0;
            const totalCount = popularTitles.size;
            
            for (const title of popularTitles) {
                try {
                    // Find the anime in JSON files
                    const anime = await findAnimeInJsonFiles(title);
                    if (anime) {
                        allAnime.push(anime);
                        
                        // Immediately create card with basic info
                        createFeaturedCard(anime);
                        
                        // Preload details in background
                        loadAnimeDetails(title).then(details => {
                            updateFeaturedCard(title, details);
                        });
                    }
                    
                    // Update progress
                    loadedCount++;
                    const percent = 10 + Math.floor((loadedCount / totalCount) * 50);
                    showProgress(percent, `Loading popular anime (${loadedCount}/${totalCount})`);
                    
                } catch (error) {
                    console.error(`Error loading ${title}:`, error);
                }
            }
            
            // Save to cache
            localStorage.setItem('cachedAnime', JSON.stringify(allAnime));
            
            // Load UI components
            loadAnimeGrid();
            
            // Update progress
            showProgress(70, "Loading remaining anime...");
            
            // Load remaining anime in background
            setTimeout(() => loadRemainingAnime(), 300);
        }
        
        // Create featured card with basic info
        function createFeaturedCard(anime) {
            const existingCard = Array.from(featuredCarousel.children).find(card => 
                card.querySelector('.anime-title')?.textContent === anime.title
            );
            
            if (existingCard) return;
            
            const card = document.createElement('div');
            card.className = 'anime-card priority-loading';
            card.dataset.title = anime.title;
            card.innerHTML = `
                <div class="anime-img">
                    <div style="background: #2a303a; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #f47521;"></i>
                    </div>
                </div>
                <div class="anime-info">
                    <div class="anime-title">${anime.title}</div>
                    <div class="anime-meta">
                        <span>Loading details...</span>
                    </div>
                </div>
            `;
            
            // Add click event to open anime page
            card.addEventListener('click', () => openAnimeDetail(anime));
            
            featuredCarousel.appendChild(card);
        }
        
        // Update featured card with details
        function updateFeaturedCard(title, details) {
            const card = featuredCarousel.querySelector(`.anime-card[data-title="${title}"]`);
            if (card) {
                card.classList.remove('priority-loading');
                card.innerHTML = `
                    <div class="anime-img">
                        <img src="${details.image}" alt="${title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                    </div>
                    <div class="anime-info">
                        <div class="anime-title">${title}</div>
                        <div class="anime-meta">
                            <span>${details.year || '?'}</span>
                            <span class="anime-rating">⭐ ${details.rating || 'N/A'}</span>
                        </div>
                    </div>
                `;
                // Reattach the click event
                const anime = allAnime.find(a => a.title === title);
                if (anime) {
                    card.addEventListener('click', () => openAnimeDetail(anime));
                }
            }
        }

        // Find anime in JSON files
        async function findAnimeInJsonFiles(title) {
            for (const file of jsonFiles) {
                try {
                    const response = await fetch(file);
                    const data = await response.json();
                    const foundAnime = data.find(anime => anime.title === title);
                    if (foundAnime) return foundAnime;
                } catch (error) {
                    console.error(`Error fetching ${file}:`, error);
                }
            }
            return null;
        }

        // Load remaining anime in background
        async function loadRemainingAnime() {
            if (isLoading) return;
            isLoading = true;
            
            // Get all anime titles we already have
            const existingTitles = new Set(allAnime.map(a => a.title));
            
            // Show status
            loadingStatus.textContent = "Loading more anime...";
            
            // Load other anime
            let loadedCount = 0;
            for (const file of jsonFiles) {
                try {
                    const response = await fetch(file);
                    const data = await response.json();
                    
                    for (const anime of data) {
                        if (!existingTitles.has(anime.title)) {
                            allAnime.push(anime);
                            existingTitles.add(anime.title);
                            loadedCount++;
                            
                            // Update status
                            if (loadedCount % 10 === 0) {
                                loadingStatus.textContent = `Loaded ${loadedCount} additional anime...`;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error loading ${file}:`, error);
                    loadingStatus.textContent = "Error loading some anime data";
                }
            }
            
            // Update cache
            localStorage.setItem('cachedAnime', JSON.stringify(allAnime));
            loadingStatus.textContent = `Loaded ${loadedCount} additional anime!`;
            
            // Update the grid
            if (displayedAnime > 0) {
                loadAnimeGrid();
            }
            
            isLoading = false;
            hideProgress();
        }

        // Load initial UI components
        function loadInitialUI() {
            // Load featured anime
            loadFeaturedAnime();
            
            // Load anime grid
            loadAnimeGrid();
        }

        // Load featured anime
        function loadFeaturedAnime() {
            // Get popular anime for featured section
            const featuredTitles = new Set(Object.values(popularAnimeByGenre).flat());
            const featuredAnime = allAnime.filter(anime => featuredTitles.has(anime.title));
            
            // Clear existing content
            featuredCarousel.innerHTML = '';
            
            // Create cards for featured anime
            featuredAnime.forEach(anime => {
                createFeaturedCard(anime);
                
                // Load details in background
                loadAnimeDetails(anime.title).then(details => {
                    updateFeaturedCard(anime.title, details);
                });
            });
        }

        // Load anime details from cache or API
        async function loadAnimeDetails(title) {
            // Check cache first
            if (animeDetailsCache[title]) {
                return animeDetailsCache[title];
            }
            
            // Show loading indicator for this item
            const cards = document.querySelectorAll(`[data-title="${title}"]`);
            cards.forEach(card => {
                card.classList.add('priority-loading');
            });

            try {
                const response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`);
                const data = await response.json();

                if (data.data && data.data.length > 0) {
                    const details = data.data[0];
                    const animeDetails = {
                        title: details.title || title,
                        image: details.images?.jpg?.image_url || 'https://via.placeholder.com/300x450?text=No+Image',
                        description: details.synopsis || 'No description available.',
                        rating: details.score ? details.score.toFixed(1) : 'N/A',
                        episodes: details.episodes || '?',
                        year: details.year || '?',
                        status: details.status || 'Unknown',
                        genres: details.genres ? details.genres.map(g => g.name) : ['Unknown']
                    };

                    // Add to cache
                    animeDetailsCache[title] = animeDetails;

                    // Update cache
                    localStorage.setItem('cachedAnimeDetails', JSON.stringify(animeDetailsCache));
                    
                    // Update cards
                    cards.forEach(card => {
                        card.classList.remove('priority-loading');
                        updateCardWithDetails(card, animeDetails);
                    });

                    return animeDetails;
                }
            } catch (error) {
                console.error(`Error fetching details for ${title}:`, error);
            }

            // Return default if no data found
            const defaultDetails = {
                title,
                image: 'https://via.placeholder.com/300x450?text=No+Image',
                description: 'No description available.',
                rating: 'N/A',
                episodes: '?',
                year: '?',
                status: 'Unknown',
                genres: ['Unknown']
            };

            animeDetailsCache[title] = defaultDetails;
            
            // Update cards
            cards.forEach(card => {
                card.classList.remove('priority-loading');
                updateCardWithDetails(card, defaultDetails);
            });
            
            return defaultDetails;
        }

        // Load anime grid with current filter
        function loadAnimeGrid() {
            if (isLoading) return;
            isLoading = true;
            
            // Show status
            loadingStatus.textContent = "Loading anime...";
            
            // Filter anime by current genre and search term
            let filteredAnime = allAnime;

            // Apply genre filter
            if (currentGenre !== 'all') {
                filteredAnime = filteredAnime.filter(anime => {
                    const details = animeDetailsCache[anime.title];
                    return details && details.genres && 
                           details.genres.some(genre => 
                               genre.toLowerCase().includes(currentGenre.toLowerCase())
                           );
                });
            }

            // Apply search filter
            if (searchTerm) {
                filteredAnime = filteredAnime.filter(anime => {
                    // Search in title
                    if (anime.title.toLowerCase().includes(searchTerm)) return true;

                    // Search in genres
                    const details = animeDetailsCache[anime.title];
                    if (details && details.genres) {
                        return details.genres.some(genre => 
                            genre.toLowerCase().includes(searchTerm)
                        );
                    }

                    return false;
                });
            }

            // Prioritize popular anime for the current genre
            if (currentGenre !== 'all' || searchTerm) {
                const popularTitles = new Set(popularAnimeByGenre[currentGenre] || []);
                const popularAnime = filteredAnime.filter(anime => popularTitles.has(anime.title));
                const otherAnime = filteredAnime.filter(anime => !popularTitles.has(anime.title));
                filteredAnime = [...popularAnime, ...otherAnime];
            }
            
            // Get anime to display (current chunk)
            const start = displayedAnime;
            const end = start + CHUNK_SIZE;
            const animeToDisplay = filteredAnime.slice(start, end);
            
            // Update displayed count
            displayedAnime = end;
            
            // Show/hide load more button
            if (displayedAnime >= filteredAnime.length) {
                loadMore.style.display = 'none';
            } else {
                loadMore.style.display = 'block';
                loadMore.textContent = `Load More (${filteredAnime.length - displayedAnime} remaining)`;
            }
            
            // Update status
            loadingStatus.textContent = `Showing ${Math.min(displayedAnime, filteredAnime.length)} of ${filteredAnime.length} anime`;
            
            // Create grid cards
            animeToDisplay.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'grid-anime-card';
                card.dataset.title = anime.title;
                
                // Check if we have cached details
                const details = animeDetailsCache[anime.title];
                
                if (details) {
                    card.innerHTML = `
                        <div class="grid-img">
                            <img src="${details.image}" alt="${anime.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                        </div>
                        <div class="grid-info">
                            <div class="grid-title">${anime.title}</div>
                            <div class="grid-episodes">${details.episodes} episodes</div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="grid-img">
                            <div style="background: #2a303a; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: #f47521;"></i>
                            </div>
                        </div>
                        <div class="grid-info">
                            <div class="grid-title">${anime.title}</div>
                            <div class="grid-episodes">Loading details...</div>
                        </div>
                    `;
                    
                    // Load details in background
                    loadAnimeDetails(anime.title);
                }

                // Add click event to open anime page
                card.addEventListener('click', () => openAnimeDetail(anime));

                animeGrid.appendChild(card);
            });
            
            // Show message if no results
            if (filteredAnime.length === 0) {
                animeGrid.innerHTML = '<div class="no-results">No anime found matching your search criteria.</div>';
                loadMore.style.display = 'none';
            }
            
            isLoading = false;
        }

        // Handle infinite scroll
        function handleInfiniteScroll() {
            // Throttle with requestAnimationFrame
            const now = Date.now();
            if (now - lastAnimationFrame < 100) return;
            lastAnimationFrame = now;
            
            const scrollPosition = window.scrollY;
            const windowHeight = window.innerHeight;
            const bodyHeight = document.body.offsetHeight;

            // When user is near the bottom of the page
            if (scrollPosition + windowHeight >= bodyHeight - 500) {
                loadAnimeGrid();
            }
        }

        // Open anime detail modal
        async function openAnimeDetail(anime) {
            // Show loading state
            modalTitle.textContent = anime.title;
            animePoster.src = '';
            animeRating.textContent = 'N/A';
            animeEpisodes.textContent = '?';
            animeYear.textContent = '?';
            animeStatus.textContent = 'Unknown';
            animeGenres.innerHTML = '';
            animeDescription.textContent = 'Loading description...';
            episodesGrid.innerHTML = '<div class="loader-text">Loading episodes...</div>';

            // Show the modal
            animeModal.classList.add('active');

            try {
                // Load anime details
                const details = await loadAnimeDetails(anime.title);

                // Update modal with details
                animePoster.src = details.image;
                animeRating.textContent = details.rating;
                animeEpisodes.textContent = details.episodes;
                animeYear.textContent = details.year;
                animeStatus.textContent = details.status;
                animeDescription.textContent = details.description;

                // Add genres
                animeGenres.innerHTML = '';
                details.genres.forEach(genre => {
                    const tag = document.createElement('span');
                    tag.className = 'genre-tag';
                    tag.textContent = genre;
                    animeGenres.appendChild(tag);
                });

                // Load episodes for this anime
                const episodes = await findEpisodesForAnime(anime.title);

                // Display episodes
                episodesGrid.innerHTML = '';
                episodes.forEach(ep => {
                    const epCard = document.createElement('div');
                    epCard.className = 'episode-card';
                    epCard.innerHTML = `<div class="episode-number">${ep.episode}</div>`;
                    epCard.addEventListener('click', () => {
                        // Open the episode in a new tab
                        const win = window.open('', '_blank');
                        win.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>${anime.title} - ${ep.episode}</title>
                                <style>
                                    body { 
                                        margin: 0; 
                                        padding: 0; 
                                        background: #000; 
                                        display: flex; 
                                        justify-content: center; 
                                        align-items: center; 
                                        height: 100vh;
                                    }
                                    .player-container {
                                        width: 100%;
                                        max-width: 1000px;
                                        padding: 20px;
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="player-container">
                                    ${ep.iframe}
                                </div>
                            </body>
                            </html>
                        `);
                        win.document.close();
                    });
                    episodesGrid.appendChild(epCard);
                });
            } catch (error) {
                console.error('Error loading anime details:', error);
                animeDescription.textContent = 'Failed to load anime details. Please try again later.';
            }
        }

        // Find all episodes for an anime
        async function findEpisodesForAnime(title) {
            const episodes = [];

            for (const file of jsonFiles) {
                try {
                    const response = await fetch(file);
                    const data = await response.json();
                    const animeEpisodes = data.filter(anime => anime.title === title);
                    episodes.push(...animeEpisodes);
                } catch (error) {
                    console.error(`Error fetching episodes from ${file}:`, error);
                }
            }

            return episodes;
        }
    </script>
</body>
</html>